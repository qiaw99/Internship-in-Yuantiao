<!DOCTYPE html >
<html>
<head>
<title>threejs</title>
<script src="http://localhost:8080/three.js-master/build/three.js"></script>
<script src="http://localhost:8080/three.js-master/examples/js/controls/OrbitControls.js"></script>
<script src="http://localhost:8080/three.js-master/examples/js/libs/stats.min.js"></script>

<script src="http://localhost:8080/three.js-master/examples/js/libs/stats.js"></script>
<!-- <script src="js/windowResize.js"></script> -->
    <script type="x-shader/x-fragment" id="fragmentShader">
        uniform sampler2D texture1;
        //uniform sampler2D texture2;
        //纹理坐标
        varying vec2 vUv;
        uniform vec3 defaultColor;
        uniform float defaultOpacity;
        uniform float luminosityThreshold;
        uniform float smoothWidth;

        uniform float screenWidth;
		uniform float screenHeight;
        uniform float sampleDistance;
        uniform float waveFactor;

        uniform float time;
        void main(void){
            vec4 texel1 = texture2D( texture1, vUv);
            
            //vec4 texel2 = texture2D( texture2, vUv);
            vec3 vec3texel = texel1.xyz;
            if(vec3texel.x + vec3texel.y + vec3texel.z <= 0.8){
                texel1.xyz += vec3(0.8,0.8,0.0);
                vec4 color, org, tmp, add;
                float sample_dist, f;
                vec2 vin;
                vec2 uv = vUv;
                add = color = org = texel1;
                vin = ( uv - vec2( 0.5 ) ) * vec2( 1.4 );
                sample_dist = dot( vin, vin ) * 2.0;
                f = ( waveFactor * 100.0 + sample_dist ) * sampleDistance * 4.0;
                vec2 sampleSize = vec2(  1.0 / screenWidth, 1.0 / screenHeight ) * vec2( f );

                add += tmp = texture2D( texture1, uv + vec2( 0.111964, 0.993712 ) * sampleSize );
                if( tmp.b < color.b ) color = tmp;

                add += tmp = texture2D( texture1, uv + vec2( 0.846724, 0.532032 ) * sampleSize );
                if( tmp.b < color.b ) color = tmp;

                add += tmp = texture2D( texture1, uv + vec2( 0.943883, -0.330279 ) * sampleSize );
                if( tmp.b < color.b ) color = tmp;

                add += tmp = texture2D( texture1, uv + vec2( 0.330279, -0.943883 ) * sampleSize );
                if( tmp.b < color.b ) color = tmp;

                add += tmp = texture2D( texture1, uv + vec2( -0.532032, -0.846724 ) * sampleSize );
                if( tmp.b < color.b ) color = tmp;

                add += tmp = texture2D( texture1, uv + vec2( -0.993712, -0.111964 ) * sampleSize );
                if( tmp.b < color.b ) color = tmp;

                add += tmp = texture2D( texture1, uv + vec2( -0.707107, 0.707107 ) * sampleSize );
                if( tmp.b < color.b ) color = tmp;
            
                
			    color = color * vec4( 2.0 ) - ( add / vec4( 8.0 ) );
                color = color + ( add / vec4( 8.0 ) - color ) * ( vec4( 1.0 ) - vec4( sample_dist * 0.5 ) );
                vec4 temp_color = vec4( color.rgb * color.rgb * vec3( 0.95 ) + color.rgb, 1.0 );

                vec3 luma = vec3( 0.299, 0.587, 0.114 );
                float v = dot( temp_color.xyz, luma );
                vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );
                float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );
                gl_FragColor = mix( outputColor, temp_color, alpha)+ vec4(sin(time), sin(time), (sin(time)),0.0);

            }else{
                texel1-=vec4(0.8,0.8,0.8,0.8);
                gl_FragColor = texel1;
                //gl_FragColor = vec4(0.0,0.0,0.0,0.0);
            }
        }
    </script>

    <script id="vertexShader" type="x-shader/x-vertex">
        varying vec2 vUv;

        void main() {
            vUv = uv;
            gl_Position =   projectionMatrix * 
                            modelViewMatrix * 
                            vec4(position,1.0);
        }
    </script>

    <script id="lineVertexShader" type="x-shader/x-vertex">
        varying vec2 vUv;

        void main() {
            vUv = uv;
            gl_Position =   projectionMatrix * 
                            modelViewMatrix * 
                            vec4(position,1.0);
        }
    </script>

    <script type="x-shader/x-fragment" id="lineFragmentShader">
        uniform sampler2D texture1;
        //uniform sampler2D texture2;
        //纹理坐标
        varying vec2 vUv;
        uniform vec3 defaultColor;
        uniform float defaultOpacity;
        uniform float luminosityThreshold;
        uniform float smoothWidth;

        uniform float screenWidth;
		uniform float screenHeight;
        uniform float sampleDistance;
        uniform float waveFactor;

        uniform float time;
        void main(void){
            
        }
    </script>
    
</head>

<body>

<script>
    //var stats = initStats();

    var scene = new THREE.Scene();

    var camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 10000);
    camera.position.set(0, 0, 10);
    camera.lookAt(scene.position);

    var renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setClearColor(0xffffff);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    var textureLoader = new THREE.TextureLoader();
    //console.log(uniforms.texture1.texture)
    //配置shaderMaterial中的uniforms属性
    var uniforms = {
        texture1: {
            type: "t",
            value: textureLoader.load('http://localhost:8080/video/map1.png')
        }
        // ,
        // texture2: {
        //     type: "t",
        //     value: textureLoader.load('http://localhost:8080/video/road.png')
        // }
        ,
        defaultColor:{
           value:new THREE.Color(0x00000)
        }
        ,
        luminosityThreshold:{
            value: 1.0
        }
        ,
        smoothWidth:{
            value: 1.0 
        }
        ,
        defaultOpacity:{
            value: 0.0 
        }
        ,
        screenWidth:{
            value:800
        }
        ,
        screenHeight:{
            value:600
        }
        ,
        sampleDistance:{
            value:0.94
        }
        ,
        waveFactor:{
            value: 0.00125 
        }
        ,
        time:{
            value:1.0
        }
    };
    //console.log(uniforms.texture1.texture)
    //设置平铺方式
    uniforms.texture1.value.warpS = uniforms.texture1.value.warpT = THREE.RepeatWrapping;

    var planeGeometry = new THREE.PlaneGeometry(12,8);
    var planeMaterial = new THREE.ShaderMaterial({
        uniforms : uniforms,
        vertexShader: document.getElementById( 'vertexShader' ).text,
        fragmentShader: document.getElementById( 'fragmentShader' ).text,
        side:THREE.DoubleSide
    });
    //var planeMaterial = new THREE.MeshBasicMaterial( {color: 0xffff00, side: THREE.DoubleSide} );
    var plane = new THREE.Mesh(planeGeometry, planeMaterial);
    scene.add(plane);


    var geometry = new THREE.Geometry();
    geometry.vertices.push(
        new THREE.Vector3(10, 20, 0),
        new THREE.Vector3(10, 50, 0)
    );

    var uniform = {

    }
    var LineMaterial = new THREE.ShaderMaterial({
    
    });
    var line = new THREE.Line(geometry, LineMaterial);
    scene.add(line);
    

    //var orbitControls = new THREE.OrbitControls(camera);

    function render() {
       // stats.update();
       //plane.rotation.x+=0.1;
       uniforms.time.value+=0.05;
        requestAnimationFrame(render);
        renderer.render(scene, camera);
    }

    render();

</script>
</body>
</html>